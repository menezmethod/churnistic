name: Create PR from develop to master

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  pull-request:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: develop
      
      - name: Get Git Info
        id: git-info
        run: |
          # Configure git to ensure we have access to all refs
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          # Fetch all history and tags
          git fetch --prune --unshallow || git fetch --prune
          git fetch origin master:master develop:develop --force
          
          # Get number of changed files
          echo "changes=$(git diff --name-only master...develop | grep -v '^$' | wc -l | xargs)" >> $GITHUB_OUTPUT
          
          # Get additions and deletions
          STATS=$(git diff --shortstat master...develop)
          ADDITIONS=$(echo "$STATS" | grep -o '[0-9]* insertion' | grep -o '[0-9]*' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -o '[0-9]* deletion' | grep -o '[0-9]*' || echo "0")
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          # Get contributors
          echo "contributors=$(git log master..develop --format='%aN' | sort -u | paste -sd ',' -)" >> $GITHUB_OUTPUT
          
          # Get recent changes
          echo "change_summary<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:'- %s (%h)' master..develop | head -n 5 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get milestones
          echo "milestones<<EOF" >> $GITHUB_OUTPUT
          git log --grep='milestone' --pretty=format:'- %s (%h)' master..develop >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get commit count
          echo "commit_count=$(git rev-list --count master..develop)" >> $GITHUB_OUTPUT
      
      - name: Create master PR
        uses: repo-sync/pull-request@v2
        if: github.event.pull_request.merged == true
        with:
          github_token: ${{ secrets.PR_AUTH_TOKEN }}
          source_branch: "develop"
          destination_branch: "master"
          pr_title: "develop -> master"
          pr_body: |
            :robot: Automated PR from **develop** to **master**
            
            ### ğŸ“Š Statistics
            - Files changed: ${{ steps.git-info.outputs.changes }}
            - Lines added: ${{ steps.git-info.outputs.additions }}
            - Lines removed: ${{ steps.git-info.outputs.deletions }}
            - Commits: ${{ steps.git-info.outputs.commit_count }}
            - Contributors: ${{ steps.git-info.outputs.contributors }}
            
            ### ğŸ“ Key Changes
            ${{ steps.git-info.outputs.change_summary }}
            
            ### ğŸ¯ Milestones
            ${{ steps.git-info.outputs.milestones }}
            
            ### âš ï¸ Important
            - This PR requires manual review and approval
            - Please verify all changes before merging
            - Merge only when all tests pass and code reviews are complete
          pr_label: "auto-pr"